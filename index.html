<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel - Frota (GViz)</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
:root{
  --bg:#071029;
  --card:#2a71e8;
  --muted:#f7f9fa;
  --accent:#00eaff;
}

html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial}

header{display:flex;justify-content:space-between;align-items:center;padding:12px 40px;background:#020617}
header img{height:66px}
header .title{font-size:22px;font-weight:700;color:var(--accent)}
header .clock{font-size:18px;color:var(--muted)}

main{padding:12px;display:grid;grid-template-rows:1fr 1fr 1fr;gap:10px;height:calc(100vh - 92px)}

.card{background:var(--card);border-radius:10px;padding:12px;overflow:auto}
.card h2{text-align:center;color:var(--accent);margin:0 0 8px}

table{width:100%;border-collapse:collapse;font-size:14px;table-layout:fixed}
th,td{padding:8px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
thead th{position:sticky;top:0;background:#0435bf;z-index:2}

tr.status-atendido{background:rgba(147,219,112,.18)}
tr.status-andamento{background:rgba(219,147,112,.18)}
tr.status-concluido{background:rgba(0,200,120,.12)}

 
.small{text-align:center;font-size:12px;color:var(--muted)}
</style>
</head>

<body>

<audio id="beep" preload="auto">
  <source src="alerta.mp3" type="audio/mpeg">
</audio>

  
<header>
  <img src="logo.png" onerror="this.style.display='none'">
  <div class="title">MOVIMENTA√á√ÉO DI√ÅRIA</div>
  <div class="clock" id="clock"></div>
</header>

<main>
  <section class="card"><h2>PAINEL</h2><div id="painel">Carregando...</div></section>
  <section class="card"><h2>AGENDA DO DIA</h2><div id="agenda">Carregando...</div></section>
  <section class="card"><h2>AGENDA SERVI√áO SOCIAL</h2><div id="social">Carregando...</div></section>
</main>

<div class="small">Atualiza√ß√£o autom√°tica a cada 60s ‚Ä¢ Google Sheets</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";
const TAB_PAINEL = "PAINEL";
const TAB_AGENDA = "AGENDA DO DIA";
const TAB_SS     = "AGENDA SERVI√áO SOCIAL";

/* ================= √ÅUDIO ================= */
let audioUnlocked = false;

function playBeep(){
  const a = document.getElementById("beep");
  if(!a || !audioUnlocked) return;
  a.currentTime = 0;
  a.play().catch(()=>{});
}

/* üîì desbloqueio obrigat√≥rio (1 clique) */
document.addEventListener("click", () => {
  const a = document.getElementById("beep");
  if(!a || audioUnlocked) return;

  a.volume = 0.6;
  a.play().then(() => {
    a.pause();
    a.currentTime = 0;
    audioUnlocked = true;
    console.log("üîä √Åudio liberado");
  }).catch(()=>{});
}, { once:true });

/* üîä som ao carregar a p√°gina */
window.addEventListener("load", () => {
  setTimeout(playBeep, 500);
});

/* ================= REL√ìGIO ================= */
function updateClock(){
  const n = new Date();
  document.getElementById("clock").innerText =
    n.toLocaleDateString("pt-BR") + " ‚Äî " + n.toLocaleTimeString("pt-BR");
}
setInterval(updateClock,1000);
updateClock();

/* ================= HELPERS ================= */
function parseGvizText(t){
  return JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>]/g, m => ({
    "&":"&amp;", "<":"&lt;", ">":"&gt;"
  }[m]));
}

function formatCell(c){
  if(c == null) return "";
  if(typeof c === "object") return c.f ?? formatCell(c.v);
  return String(c);
}

/* ================= RENDER ================= */
function renderTable(id, g){
  const el = document.getElementById(id);
  if(!g?.table?.cols){
    el.innerHTML = "<div style='opacity:.7;text-align:center'>Sem dados</div>";
    return;
  }

  const cols = g.table.cols.map(c => c.label || "");
  const rows = g.table.rows || [];

  let h = "<table><thead><tr>";
  cols.forEach(c => h += `<th>${escapeHtml(c)}</th>`);
  h += "</tr></thead><tbody>";

  rows.forEach(r => {
    const cells = r.c || [];
    const status = String(cells.at(-1)?.f ?? cells.at(-1)?.v ?? "").toLowerCase();

    let cls = "";
    if(status.includes("andamento")) cls = "status-andamento";
    if(status.includes("concluido") || status.includes("conclu√≠do")) cls = "status-concluido";
    if(status.includes("atendido")) cls = "status-atendido";

    h += `<tr class="${cls}">`;
    cells.forEach(c => h += `<td>${escapeHtml(formatCell(c))}</td>`);
    h += "</tr>";
  });

  h += "</tbody></table>";
  el.innerHTML = h;
}

/* ================= FETCH ================= */
async function fetchSheet(tab){
  const u = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tqx=out:json&nocache=${Date.now()}`;
  const r = await fetch(u, { cache:"no-store" });
  return parseGvizText(await r.text());
}

/* ================= LOAD ================= */
async function loadAll(){
  try{
    playBeep(); // üîä som a cada atualiza√ß√£o autom√°tica

    const [p,a,s] = await Promise.all([
      fetchSheet(TAB_PAINEL),
      fetchSheet(TAB_AGENDA),
      fetchSheet(TAB_SS)
    ]);

    renderTable("painel", p);
    renderTable("agenda", a);
    renderTable("social", s);

  }catch(e){
    console.error(e);
  }
}

loadAll();
setInterval(loadAll, 10000); // 60s
</script>
